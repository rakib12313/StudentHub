<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudentHub - Admin Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4F46E5; 
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        
        /* Navbar */
        nav { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-weight: 700; font-size: 1.5rem; color: var(--primary); }
        .nav-items button { background: none; border: none; font-size: 1rem; cursor: pointer; padding: 8px 15px; }
        .nav-items button.active { color: var(--primary); font-weight: 600; }
        .auth-btn { background: var(--primary) !important; color: white !important; border-radius: 20px; }

        /* Sections */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 20px; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }

        /* Cards */
        .card { background: var(--surface); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Dashboard Grids */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        
        /* File Cards */
        .file-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; position: relative; }
        .file-preview { height: 140px; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #888; }
        .file-preview img { width: 100%; height: 100%; object-fit: cover; }
        .file-info { padding: 1rem; }
        
        /* Pending Badge */
        .badge-pending { position: absolute; top: 10px; right: 10px; background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

        /* Admin Panel Styles */
        .admin-login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 2rem; border-radius: 10px; width: 300px; text-align: center; }
        .action-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-approve { background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; flex: 1; }
        .btn-reject { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; flex: 1; }

        /* Inputs */
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav>
        <div class="logo">StudentHub <span id="admin-badge" style="display:none; font-size:0.8rem; background:var(--danger); color:white; padding:2px 6px; border-radius:4px;">ADMIN</span></div>
        <div class="nav-items">
            <button onclick="nav('home')" class="active">Home</button>
            <button onclick="nav('files')">Files</button>
            <button id="admin-tab-btn" onclick="nav('admin')" style="display:none; color: var(--danger);">Admin Panel</button>
            <button id="login-btn" class="auth-btn" onclick="googleLogin()">Login</button>
            <button id="logout-btn" style="display:none; color:red" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        
        <!-- HOME (Public Notices) -->
        <div id="home" class="section active">
            <div class="card">
                <h2>üì¢ Notice Board</h2>
                <div id="public-notices">Loading...</div>
            </div>
            <div class="card" style="text-align:center; background: linear-gradient(135deg, #4F46E5, #818cf8); color: white;">
                <h1>Study Portal</h1>
                <p>Login to upload files. Admins approve content before it goes live.</p>
            </div>
        </div>

        <!-- FILES (Public Files) -->
        <div id="files" class="section">
            <div id="upload-box" class="card" style="display:none;">
                <h3>üì§ Upload Material (Requires Approval)</h3>
                <input type="text" id="file-title" placeholder="Title (e.g. Physics Notes)">
                <select id="file-tag"><option>PDF</option><option>Image</option></select>
                <input type="file" id="file-input">
                <div id="loader" style="display:none; color:var(--primary);">Uploading... Please wait.</div>
                <button onclick="uploadFile()" class="auth-btn" style="width:100%">Submit for Review</button>
            </div>

            <h2>üìö Approved Materials</h2>
            <div id="public-gallery" class="grid"></div>
        </div>

        <!-- ADMIN PANEL (Protected) -->
        <div id="admin" class="section">
            <div class="card" style="border-left: 5px solid var(--danger);">
                <h2>üîí Admin Control Center</h2>
                <p>Manage pending requests and sub-admins.</p>
                <button onclick="logoutAdmin()" style="background:#555; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Exit Admin Mode</button>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                
                <!-- Pending Files -->
                <div>
                    <h3>‚è≥ Pending Files</h3>
                    <div id="admin-files">No pending files.</div>
                </div>

                <!-- Pending Notices -->
                <div>
                    <h3>‚è≥ Pending Notices</h3>
                    <!-- Admin posts directly here -->
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="admin-notice-input" placeholder="Post official notice...">
                        <button onclick="postNotice()" class="auth-btn" style="width:100%">Post / Request</button>
                    </div>
                    <div id="admin-notices">No pending notices.</div>
                </div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <h3>üë• Manage Sub-Admins</h3>
                <div style="display:flex; gap:10px;">
                    <input type="email" id="new-admin-email" placeholder="Enter google email to make admin">
                    <button onclick="addSubAdmin()" class="auth-btn">Add</button>
                </div>
                <div id="admin-list" style="margin-top:10px; color:#666;"></div>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN MODAL -->
    <div id="admin-modal" class="admin-login-overlay" style="display:none;">
        <div class="login-box">
            <h2>Admin Access</h2>
            <input type="text" id="admin-user" placeholder="Username">
            <input type="password" id="admin-pass" placeholder="Password">
            <button onclick="verifyAdminPass()" class="auth-btn" style="width:100%">Unlock</button>
            <button onclick="closeAdminModal()" style="background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, where, onSnapshot, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG (REPLACE WITH YOUR KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3fovDzCF_3mCFD4yGsvgCFfan_tuDc3Y",
            authDomain: "studenthub-599bf.firebaseapp.com",
            projectId: "studenthub-599bf",
            storageBucket: "studenthub-599bf.firebasestorage.app",
            messagingSenderId: "46949030478",
            appId: "1:46949030478:web:75e914274035b1d5d8c11f"
        };
        const CLOUD_NAME = "dvmwnkyyh"; 
        const UPLOAD_PRESET = "StudentHub"; 

        // --- INIT ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let isAdmin = false;

        // --- AUTH & ADMIN CHECK ---
        window.googleLogin = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => window.location.reload());

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('upload-box').style.display = 'block';
                
                // Check if user is a Sub-Admin via Firestore
                checkIfSubAdmin(user.email);
            }
        });

        // 1. MASTER LOGIN (Rakib/adminrakib)
        // This button is triggered by a hidden mechanism or Manual Logic
        // For this demo, I will add a "Unlock Admin" button in the footer or nav if you click "StudentHub"
        document.querySelector('.logo').addEventListener('click', () => {
            if(!isAdmin) document.getElementById('admin-modal').style.display = 'flex';
        });

        window.verifyAdminPass = () => {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            
            if(u === "Rakib" && p === "adminrakib") {
                activateAdminMode();
                document.getElementById('admin-modal').style.display = 'none';
                alert("Master Admin Logged In");
            } else {
                alert("Wrong Credentials");
            }
        };

        window.closeAdminModal = () => document.getElementById('admin-modal').style.display = 'none';

        // 2. SUB-ADMIN CHECK
        async function checkIfSubAdmin(email) {
            const q = query(collection(db, "admins"), where("email", "==", email));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                activateAdminMode();
            }
        }

        function activateAdminMode() {
            isAdmin = true;
            document.getElementById('admin-tab-btn').style.display = 'inline-block';
            document.getElementById('admin-badge').style.display = 'inline-block';
            loadPendingData(); // Start listening for pending stuff
            loadAdminList();
        }

        window.logoutAdmin = () => {
            isAdmin = false;
            window.location.reload();
        }

        // --- UPLOAD & POST (Sends to 'pending') ---
        window.uploadFile = async () => {
            if(!currentUser) return alert("Please Login");
            
            const file = document.getElementById('file-input').files[0];
            const title = document.getElementById('file-title').value;
            const tag = document.getElementById('file-tag').value;
            
            if(!file) return;
            document.getElementById('loader').style.display = 'block';

            // Cloudinary Upload
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method: 'POST', body: formData });
            const data = await res.json();

            // Save to Firestore with status: 'pending' (unless it's an admin, then auto-approve)
            const status = isAdmin ? 'approved' : 'pending';
            
            await addDoc(collection(db, "files"), {
                title: title, url: data.secure_url, type: tag, 
                uploader: currentUser.displayName, status: status, 
                timestamp: serverTimestamp()
            });

            document.getElementById('loader').style.display = 'none';
            alert(isAdmin ? "File Uploaded!" : "File sent for approval!");
            document.getElementById('file-title').value = "";
        };

        window.postNotice = async () => {
            const msg = document.getElementById('admin-notice-input').value;
            if(!msg) return;
            
            const status = isAdmin ? 'approved' : 'pending';
            
            await addDoc(collection(db, "notices"), {
                message: msg, author: currentUser.displayName, 
                status: status, timestamp: serverTimestamp()
            });
            document.getElementById('admin-notice-input').value = "";
            if(!isAdmin) alert("Notice sent for approval");
        };

        // --- DISPLAY DATA (Public vs Admin) ---

        // 1. Public Data (Approved Only)
        const qPublicFiles = query(collection(db, "files"), where("status", "==", "approved"));
        onSnapshot(qPublicFiles, (snap) => {
            let html = "";
            snap.forEach(doc => {
                const d = doc.data();
                const icon = d.type === 'PDF' ? 'üìÑ' : `<img src="${d.url}" style="width:100%;height:100%;object-fit:cover">`;
                html += `
                <div class="file-card">
                    <div class="file-preview">${icon}</div>
                    <div class="file-info">
                        <h4>${d.title}</h4>
                        <a href="${d.url}" target="_blank" style="color:var(--primary)">Download</a>
                    </div>
                </div>`;
            });
            document.getElementById('public-gallery').innerHTML = html;
        });

        const qPublicNotices = query(collection(db, "notices"), where("status", "==", "approved"));
        onSnapshot(qPublicNotices, (snap) => {
            let html = "";
            snap.forEach(doc => {
                html += `<div class="card" style="border-left:4px solid var(--primary); padding:10px;">${doc.data().message}<br><small>${doc.data().author}</small></div>`;
            });
            document.getElementById('public-notices').innerHTML = html || "No notices.";
        });

        // 2. Admin Data (Pending Only)
        function loadPendingData() {
            // Files
            const qPendingFiles = query(collection(db, "files"), where("status", "==", "pending"));
            onSnapshot(qPendingFiles, (snap) => {
                let html = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                    <div class="card">
                        <strong>${d.title}</strong> (${d.type})<br>
                        <small>By: ${d.uploader}</small><br>
                        <a href="${d.url}" target="_blank">View File</a>
                        <div class="action-row">
                            <button class="btn-approve" onclick="reviewItem('files', '${doc.id}', 'approved')">Approve</button>
                            <button class="btn-reject" onclick="reviewItem('files', '${doc.id}', 'reject')">Reject</button>
                        </div>
                    </div>`;
                });
                document.getElementById('admin-files').innerHTML = html || "All caught up!";
            });

            // Notices
            const qPendingNotices = query(collection(db, "notices"), where("status", "==", "pending"));
            onSnapshot(qPendingNotices, (snap) => {
                let html = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                    <div class="card">
                        "${d.message}"<br>
                        <small>By: ${d.author}</small>
                        <div class="action-row">
                            <button class="btn-approve" onclick="reviewItem('notices', '${doc.id}', 'approved')">Approve</button>
                            <button class="btn-reject" onclick="reviewItem('notices', '${doc.id}', 'reject')">Reject</button>
                        </div>
                    </div>`;
                });
                document.getElementById('admin-notices').innerHTML = html || "All caught up!";
            });
        }

        // --- ADMIN ACTIONS ---
        window.reviewItem = async (col, id, action) => {
            if(action === 'approved') {
                await updateDoc(doc(db, col, id), { status: 'approved' });
            } else {
                if(confirm("Delete this item permanently?")) {
                    await deleteDoc(doc(db, col, id));
                }
            }
        };

        window.addSubAdmin = async () => {
            const email = document.getElementById('new-admin-email').value;
            if(!email) return;
            await addDoc(collection(db, "admins"), { email: email });
            document.getElementById('new-admin-email').value = "";
            alert("Sub-admin added! They can now login via Google.");
        };

        function loadAdminList() {
            onSnapshot(collection(db, "admins"), (snap) => {
                let html = "<strong>Authorized Emails:</strong><br>";
                snap.forEach(doc => { html += `‚Ä¢ ${doc.data().email} <br>`; });
                document.getElementById('admin-list').innerHTML = html;
            });
        }

        // --- NAVIGATION ---
        window.nav = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };
    </script>
</body>
</html>
